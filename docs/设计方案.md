这是一个使用 FastAPI 构建现代化 RBAC 权限管理系统的设计方案（后端）。

### 整体架构

  - **分层架构：** API 层 → 服务层 → DAO 层 → 模型层，职责清晰，低耦合、可协作。
      - **API 层 (Controllers):** 处理 HTTP、验证输入、装配依赖、调用服务层。
      - **服务层 (Services):** 业务编排、权限校验、缓存、事务边界、审计。
      - **DAO 层 (Data Access):** 封装数据库 CRUD/批量/查询构造、软删过滤、乐观锁。
      - **模型层 (Models):** Tortoise-ORM 表结构、索引、约束。

---

### 核心模块与技术栈

#### 1. 项目结构

```bash
rbac-system/
├── app/
│   ├── api/
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py          # 登录、刷新、注销
│   │   │   ├── users.py         # 用户 API
│   │   │   ├── roles.py         # 角色 API
│   │   │   ├── permissions.py   # 权限 API
│   │   │   └── logs.py          # 审计日志 API
│   │   └── __init__.py
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py            # 配置（pydantic-settings）
│   │   ├── constants.py         # 权限常量/枚举
│   │   ├── database.py          # Tortoise 连接与初始化
│   │   ├── dependencies.py      # 依赖注入（当前用户/权限）
│   │   ├── exceptions.py        # 自定义异常与错误工厂
│   │   ├── security.py          # JWT、密码哈希、Token 工具
│   │   └── lifespan.py          # 应用生命周期（DB/Redis/log）
│   ├── dao/
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── user.py
│   │   ├── role.py
│   │   ├── permission.py
│   │   └── log.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── role.py
│   │   ├── permission.py
│   │   └── log.py
│   ├── services/
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── role.py
│   │   ├── permission.py
│   │   └── log.py
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── response.py          # 统一响应模型（泛型）
│   │   ├── user.py
│   │   ├── role.py
│   │   ├── permission.py
│   │   └── log.py
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── logger.py            # loguru 配置
│   │   └── cache.py             # Redis 客户端与封装
│   └── main.py                  # FastAPI 应用入口
├── migrations/                  # Aerich 迁移
├── tests/
│   ├── api/
│   │   ├── test_users.py
│   │   ├── test_roles.py
│   │   ├── test_permissions.py
│   │   └── test_auth.py
│   └── conftest.py
├── scripts/                     # 脚本，如初始化数据
├── .env
├── .env.example
├── pyproject.toml
├── requirements.txt
├── uv.lock
└── README.md
```

#### 2. 主要技术实现

**认证与令牌（OAuth2 标准）**

  - 使用 `OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login")`；登录返回 `access_token` 与 `token_type`（Bearer）。
  - 令牌策略：短期 `access_token` + 长期 `refresh_token`；支持注销（黑名单/版本号策略）。
  - Token 载荷最小化：`sub`、`uid`、`ver`、`exp`；权限从缓存/DB 动态获取。
  - 密码哈希：`argon2` 或 `bcrypt`；登录失败计数与冻结（字段：`failed_attempts`、`locked_until`）。

**FastAPI 依赖注入**

  - `get_current_active_user` 从 JWT 解析用户并校验状态；
  - `has_permission(required: Permission)` 依赖在路由注入，例如：
    `@router.get("/users", dependencies=[Depends(has_permission(Permission.USER_LIST))])`。

**RBAC 建模与权限常量**

  - 关系：`User -< UserRole >- Role -< RolePermission >- Permission`（多对多）。
  - 命名规范：`resource:action`，如 `user:list`、`user:bulk_delete`。
  - 权限常量定义在 `app/core/constants.py`，使用枚举：
    ```python
    from enum import StrEnum

    class Permission(StrEnum):
        USER_LIST = "user:list"
        USER_CREATE = "user:create"
        USER_UPDATE = "user:update"
        USER_DELETE = "user:delete"
        USER_BULK_DELETE = "user:bulk_delete"
    ```

**数据安全（软删除）与并发（乐观锁）**

  - 软删除：所有表包含 `is_deleted: bool`、`deleted_at: datetime | None`，DAO 默认过滤 `is_deleted=False`；
    唯一键冲突通过“仅对活跃记录唯一”策略或联合索引规避（如 `UNIQUE (email) WHERE is_deleted = FALSE`）。
  - 乐观锁：模型含 `version: IntField`；更新时 `filter(id=..., version=old).update(..., version=old+1)`，
    受影响行数为 0 视为冲突并返回 409。
  - 索引：为高频写表建立 `(id, version)` 复合索引；软删过滤列建联合索引。

**批量操作（DAO 层）**

  - 提供：`bulk_create`、`bulk_update`、`bulk_soft_delete`、`bulk_upsert`；
  - 语义：返回影响条数；失败聚合为结构化错误。

**Redis 权限缓存**

  - Key：`rbac:perm:v{perm_version}:u:{user_id}`；设置 `TTL`（10-30 分钟）。
  - 写入时机：登录、权限变更；读取优先缓存，miss 回源并回填。
  - 失效：用户角色/角色权限/权限项变更后按用户失效，或统一 bump 全局 `perm_version`。

**操作审计日志**

  - 采集：`actor_id`、`ip`、`ua`、`path`、`method`、`action`、`target_id`、`status`、`latency_ms`、`trace_id`、`error`。
  - 形态：服务层装饰器 `@log_operation(action=...)`；异步写入 DB（任务/队列）。
  - 与 loguru 统一 trace：请求中间件生成 `trace_id`（入响应头）。

**统一响应与异常**

  - 所有业务接口返回统一模型（登录除外）：
    ```python
    from typing import Generic, TypeVar
    from pydantic import BaseModel

    T = TypeVar("T")

    class Response(BaseModel, Generic[T]):
        code: int
        message: str
        data: T | None = None
    ```
  - 分页统一：查询参数 `page`、`page_size`、`sort`、`order`，返回 `items/total/page/page_size`。
  - 异常：定义领域异常并在全局异常处理器中映射为 HTTP 状态码与错误体；兜底隐藏内部细节。

**Tortoise、Pydantic v2 与 Python 版本**

  - 建议独立定义 Pydantic Schema（入/出），避免直接使用 `pydantic_model_creator`；
  - 确认与 `pydantic v2` 的兼容版本。

**配置与生命周期**

  - `pydantic-settings` 加载环境；分环境配置（dev/staging/prod）。
  - 使用 `lifespan` 管理启动/关闭：初始化 DB、Redis、日志器、CORS；避免 `@on_event`。
  - 健康检查：`/health`（探测 DB/Redis）。

**数据库与迁移**

  - Aerich：配置 `tortoise_orm` 路径、迁移目录、`use_tz=True`、`generate_schemas=False`；
  - 事务：服务层聚合多 DAO 写时使用事务，避免跨事务导致版本冲突。

**日志与可观测性（loguru）**

  - 开发：彩色控制台；生产：JSON + 滚动文件；敏感字段脱敏；
  - 中间件：统一请求日志（状态码、耗时、trace_id），慢查询阈值告警。

**API 设计一致性**

  - 前缀：`/api/v1`；模块化路由器命名导出；
  - 输入校验：Pydantic v2 严格模型；
  - 幂等（可选）：关键写接口支持 `Idempotency-Key`。

**文档与测试**

  - README：快速启动（docker-compose 启动 Postgres/Redis）、迁移流程、环境变量说明；
  - 测试：`pytest-asyncio` + `httpx.AsyncClient`（含 lifespan）；构造工厂；可选 testcontainers。

### 统一响应格式

  - 统一响应位于 `app/schemas/response.py`，除登录外均使用。
  - 成功响应示例：
    ```json
    {
      "code": 200,
      "message": "success",
      "data": { }
    }
    ```
  - **登录响应：** 严格遵循 OAuth2，返回 `access_token` 与 `token_type`（可另含 `refresh_token`）。

### 易错点与约束

  - 权限缓存需设计版本号与失效策略，避免脏读；
  - 软删除下的唯一约束需提前规划（部分唯一或逻辑唯一）；
  - 批量操作要保证事务性与错误聚合；
  - 权限常量统一从 `constants.py` 引用，禁止硬编码字符串。
